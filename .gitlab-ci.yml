image: debian  # Usa imagem base Debian para executar os jobs

before_script:
  - apt update
  - apt install openssh-client sshpass -y

stages:
  - production
  - develop

production:
  stage: production
  script:
    - sshpass -v -p $SSHPASS ssh -o "StrictHostKeyChecking no" $USERNAME@$SERVER_IP_PROD "cd $SERVER_PATH_PROD && git pull --no-rebase"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "cd $SERVER_PATH_PROD && docker-compose down"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker stop $IMAGE_NAME || true"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker rm -f $IMAGE_NAME || true"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker tag $IMAGE_NAME:latest $IMAGE_NAME:$(date +%Y%m%d%H%M%S)"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker build $SERVER_PATH_PROD -t $IMAGE_NAME:latest"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "cd $SERVER_PATH_PROD && docker-compose up -d"

    # Roda composer install e key:generate ap√≥s subir o container
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker exec $IMAGE_NAME composer install --no-interaction --prefer-dist"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker exec $IMAGE_NAME php artisan key:generate"

  only:
    - master

develop:
  stage: develop
  script:
    - sshpass -v -p $SSHPASS ssh -o "StrictHostKeyChecking no" $USERNAME@$SERVER_IP_PROD "cd $SERVER_PATH_DEV && git pull origin dev --no-rebase"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "cd $SERVER_PATH_DEV && docker-compose down"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker stop $IMAGE_NAME_DEV || true"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker rm -f $IMAGE_NAME_DEV || true"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker tag $IMAGE_NAME_DEV:latest $IMAGE_NAME_DEV:$(date +%Y%m%d%H%M%S)"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker build $SERVER_PATH_DEV -t $IMAGE_NAME_DEV:latest"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "cd $SERVER_PATH_DEV && docker-compose up -d"

    # Roda composer install e key:generate para ambiente dev
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker exec $IMAGE_NAME_DEV composer install --no-interaction --prefer-dist"
    - sshpass -v -p $SSHPASS ssh $USERNAME@$SERVER_IP_PROD "docker exec $IMAGE_NAME_DEV php artisan key:generate"

  only:
    - dev
